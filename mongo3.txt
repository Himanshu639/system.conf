db.createCollection("order");
db.order.insert({id:'A1',amount:400,status:'P'});
db.order.insertMany([{id:'B1',amount:300,status:'D'},
                     {id:'A1',amount:200,status:'F'}]);
db.order.mapReduce(
    function() {
        if (this.status === 'P') {
            emit(this.id, this.amount);
        }
    },
    function(key, values) {
        return Array.avg(values);
    },
    {
        query: { status: 'P' },
        out: "out_collection"
    }
);